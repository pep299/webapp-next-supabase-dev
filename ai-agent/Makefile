# Claude Code Container Makefile
# å‹•çš„ãƒãƒ¼ãƒˆæ¤œå‡ºã¨ã‚³ãƒ³ãƒ†ãƒŠãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

SHELL := /bin/bash
.PHONY: help build build-with-token run test stop clean-containers clean-images clean-cache clean-all

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "ðŸ³ Claude Code Container Management"
	@echo ""
	@echo "ðŸ“‹ Available commands:"
	@echo "  make build GITHUB_TOKEN=xxx   - ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make run                       - ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•"
	@echo "  make test                      - Container Structure Testã‚’å®Ÿè¡Œ"
	@echo "  make stop                      - å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢"
	@echo "  make clean-containers          - åœæ­¢æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤"
	@echo ""
	@echo "ðŸ’¡ Usage example:"
	@echo "  make build GITHUB_TOKEN=gho_xxxxxxx"
	@echo "  make run"

# è¨­å®š
IMAGE_NAME := claude-code-webapp
CONTAINER_NAME_PREFIX := $(IMAGE_NAME)


# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æŒ‡å®šï¼‰
build-with-token:
ifndef GITHUB_TOKEN
	$(error GITHUB_TOKEN is required. Usage: make build-with-token GITHUB_TOKEN=gho_xxxxxxxxxxxx)
endif
	echo "ðŸ”¨ Building Claude Code container..."
	docker build \
		--build-arg GITHUB_TOKEN="$(GITHUB_TOKEN)" \
		-t $(IMAGE_NAME):latest \
		-f claude-code/Dockerfile \
		..
	echo "âœ… Build completed: $(IMAGE_NAME):latest"

# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆè‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
build:
	$(MAKE) build-with-token GITHUB_TOKEN="$(shell gh auth token 2>/dev/null || echo "")"

# ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ
run:
	docker run -it --rm -p 3000:3000 -p 3001:3001 -p 54320:54320 $(IMAGE_NAME):latest

# Container Structure Testå®Ÿè¡Œ
test:
	@which container-structure-test > /dev/null || (echo "âŒ container-structure-test not installed" && exit 1)
	container-structure-test test --image $(IMAGE_NAME):latest --config claude-code/container-test.yaml

# ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ï¼ˆåå‰æŒ‡å®šã‚³ãƒ³ãƒ†ãƒŠç”¨ï¼‰
stop:
	@echo "Note: 'make run' uses --rm flag, containers are auto-removed"
	@RUNNING=$$(docker ps -q --filter "name=$(CONTAINER_NAME_PREFIX)" 2>/dev/null || echo ""); \
	if [ -n "$$RUNNING" ]; then docker stop $$RUNNING; else echo "No containers to stop"; fi

# åœæ­¢æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
clean-containers:
	@STOPPED=$$(docker ps -aq --filter "name=$(CONTAINER_NAME_PREFIX)" --filter "status=exited" 2>/dev/null || echo ""); \
	if [ -n "$$STOPPED" ]; then docker rm $$STOPPED; else echo "No containers to clean"; fi

# æœªä½¿ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤
clean-images:
	docker image prune -f

# ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
clean-cache:
	docker builder prune -f

# å…¨å‰Šé™¤ï¼ˆå±é™ºï¼‰
clean-all: stop clean-containers
	@read -p "Remove ALL containers, images, and cache? [y/N] " -n 1 -r && echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker image rm $(IMAGE_NAME):latest 2>/dev/null || echo "Image not found"; \
		docker system prune -a -f; \
	fi