# Claude Code Container Makefile
# å‹•çš„ãƒãƒ¼ãƒˆæ¤œå‡ºã¨ã‚³ãƒ³ãƒ†ãƒŠãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

SHELL := /bin/bash
export DOCKER_HOST := unix:///Users/$(USER)/.colima/default/docker.sock
.PHONY: help build build-with-token run test stop clean-containers clean-images clean-cache clean-all prepare-config

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "ðŸ³ Claude Code Container Management"
	@echo ""
	@echo "ðŸ“‹ Available commands:"
	@echo "  make build GITHUB_TOKEN=xxx   - ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make run                       - ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•"
	@echo "  make test                      - Container Structure Testã‚’å®Ÿè¡Œ"
	@echo "  make stop                      - å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢"
	@echo "  make clean-containers          - åœæ­¢æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤"
	@echo "  make prepare-config            - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™"
	@echo ""
	@echo "ðŸ’¡ Usage example:"
	@echo "  make build GITHUB_TOKEN=gho_xxxxxxx"
	@echo "  make run"

# è¨­å®š
IMAGE_NAME := claude-code-webapp
CONTAINER_NAME_PREFIX := $(IMAGE_NAME)

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
prepare-config:
	@echo "ðŸ“‹ Preparing Claude Code configuration files..."
	@mkdir -p claude-code/config/.claude
	@mkdir -p claude-code/config/.config/claude-code
	@# Copy user Claude Code settings if they exist, otherwise create default
	@if [ -f ~/.claude/settings.json ]; then \
		echo "âœ… Copying user settings from ~/.claude/settings.json"; \
		cp ~/.claude/settings.json claude-code/config/.claude/settings.json; \
	else \
		echo "ðŸ“ Creating default settings.json"; \
		echo '{"hooks": {"PreToolUse": [], "Stop": []}}' > claude-code/config/.claude/settings.json; \
	fi
	@# Copy hooks scripts if they exist (from both locations)
	@SCRIPTS_FOUND=false; \
	if [ -d ~/.claude ] && [ -n "$$(find ~/.claude -name '*.py' 2>/dev/null)" ]; then \
		echo "âœ… Copying hooks scripts from ~/.claude/"; \
		find ~/.claude -name '*.py' | xargs -I {} cp {} claude-code/config/.config/claude-code/; \
		SCRIPTS_FOUND=true; \
	fi; \
	if [ -d ~/.config/claude-code ] && [ -n "$$(find ~/.config/claude-code -name '*.py' 2>/dev/null)" ]; then \
		echo "âœ… Copying hooks scripts from ~/.config/claude-code/"; \
		find ~/.config/claude-code -name '*.py' | xargs -I {} cp {} claude-code/config/.config/claude-code/; \
		SCRIPTS_FOUND=true; \
	fi; \
	if [ "$$SCRIPTS_FOUND" = "false" ]; then \
		echo "ðŸ“ No hooks scripts found - using default empty configuration"; \
	fi
	@# Extract MCP servers configuration from ~/.claude.json or create default
	@if [ -f ~/.claude.json ] && command -v jq >/dev/null 2>&1; then \
		echo "âœ… Extracting MCP servers from ~/.claude.json"; \
		jq '{mcpServers: (.mcpServers // {})}' ~/.claude.json > claude-code/config/.mcp.json; \
	else \
		echo "ðŸ“ Creating default .mcp.json with context7 and playwright"; \
		echo '{"mcpServers": {"context7": {"type": "stdio", "command": "npx", "args": ["-y", "@upstash/context7-mcp@latest"], "env": {}}, "playwright": {"type": "stdio", "command": "npx", "args": ["-y", "@playwright/mcp@latest"], "env": {}}}}' > claude-code/config/.mcp.json; \
	fi
	@echo "âœ… Configuration preparation completed"

# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ãƒˆãƒ¼ã‚¯ãƒ³æŒ‡å®šï¼‰
build-with-token: prepare-config
ifndef GITHUB_TOKEN
	$(error GITHUB_TOKEN is required. Usage: make build-with-token GITHUB_TOKEN=gho_xxxxxxxxxxxx)
endif
	@echo "ðŸ”¨ Building Claude Code container..."
	@echo "$(GITHUB_TOKEN)" > claude-code/.github_token_secret
	@docker buildx build \
		--secret id=github_token,src=claude-code/.github_token_secret \
		$(if $(GIT_USER_NAME),--build-arg GIT_USER_NAME="$(GIT_USER_NAME)") \
		$(if $(GIT_USER_EMAIL),--build-arg GIT_USER_EMAIL="$(GIT_USER_EMAIL)") \
		-t $(IMAGE_NAME):latest \
		-f claude-code/Dockerfile \
		..
	@rm -f claude-code/.github_token_secret
	@echo "âœ… Build completed: $(IMAGE_NAME):latest"

# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆè‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‹Gitè¨­å®šï¼‰
build:
	$(MAKE) build-with-token \
		GITHUB_TOKEN="$(shell gh auth token 2>/dev/null || echo "")" \
		GIT_USER_NAME="$(shell git config --global user.name 2>/dev/null || echo "")" \
		GIT_USER_EMAIL="$(shell git config --global user.email 2>/dev/null || echo "")"

# ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ
run:
	docker run -it --rm -p 3000:3000 -p 3001:3001 -p 54320:54320 $(IMAGE_NAME):latest

# Container Structure Testå®Ÿè¡Œ  
test:
	@which container-structure-test > /dev/null || (echo "âŒ container-structure-test not installed" && exit 1)
	container-structure-test test --image $(IMAGE_NAME):latest --config claude-code/container-test.yaml

# ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ï¼ˆåå‰æŒ‡å®šã‚³ãƒ³ãƒ†ãƒŠç”¨ï¼‰
stop:
	@echo "Note: 'make run' uses --rm flag, containers are auto-removed"
	@RUNNING=$$(docker ps -q --filter "name=$(CONTAINER_NAME_PREFIX)" 2>/dev/null || echo ""); \
	if [ -n "$$RUNNING" ]; then docker stop $$RUNNING; else echo "No containers to stop"; fi

# åœæ­¢æ¸ˆã¿ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
clean-containers:
	@STOPPED=$$(docker ps -aq --filter "name=$(CONTAINER_NAME_PREFIX)" --filter "status=exited" 2>/dev/null || echo ""); \
	if [ -n "$$STOPPED" ]; then docker rm $$STOPPED; else echo "No containers to clean"; fi

# æœªä½¿ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤
clean-images:
	docker image prune -f

# ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
clean-cache:
	docker builder prune -f

# å…¨å‰Šé™¤ï¼ˆå±é™ºï¼‰
clean-all: stop clean-containers
	@read -p "Remove ALL containers, images, and cache? [y/N] " -n 1 -r && echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker image rm $(IMAGE_NAME):latest 2>/dev/null || echo "Image not found"; \
		docker system prune -a -f; \
	fi